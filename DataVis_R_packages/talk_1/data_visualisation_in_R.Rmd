---
title: "Data visualisation in R"
author: "Jackson Kwok"
date: "7 March 2016"
output: 
  ioslides_presentation:
    incremental: true
    smaller: false
---
```{r setup, include = F}
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warnings = FALSE)
```

## Style of this talk
- Task-based learning.
- Quick start + References.
- Plan: Skim through some examples and work closely on two of them.

## What you'll able to do after this talk
![Image](img//economist_samples//20110917_WOC618.gif)

##
```{r, echo = FALSE}
load('input_output//plotly_demo_1')
library(plotly)
plot_ly(data = GDP_spending, mode = 'markers+text',  
        x = GDP_per_person, y = Anticipated_spending, text = Country,
        textposition = 'top',
        marker = list(symbol = "circle-open", 
                      size = 9, 
                      line = list(width = 2))
        ) %>% 
  layout(title = "Anticipated personal spending for 2013, USD",
         xaxis = list(title = "Anticipated spending on Christmas Gift"),
         yaxis = list(title = "GDP per person"))
```

##
```{r, echo = FALSE}
load('input_output//life_expectancy')
library(ggthemes)
plot_ly(life_expectancy, mode = 'markers',
        x = GDP_per_capita, y = Life_expectancy, 
        marker = list(size = Marker_Size, color = colorblind_pal()(5)[Group_num]),
        hoverinfo = 'text', text = Country) %>%
  layout(title = "",
         xaxis = list(title = "GDP per capita"),
         yaxis = list(title = "Life Expectancy (years)"))
```



#Preliminaries

## Data visualisation. Why?

- Exploratory analysis

    - Get a sense of what data looks like
    - Help you choose (parametric) models
    - Help you engineer features 

- Confirmatory analysis

    - Model fit evaluation
    - Residual analysis

## Examples - choose parametric models 
Data: Copenhagen Reinsurance 2167 fire losses records from 1980 to 1990. 

```{r, echo = FALSE}
library(SMPracticals)
data("danish")
hist(danish, breaks = 800, 
     main = 'Danish fire losses', 
     xlab = "millions of Danish Krone",
     ylab = "counts", 
     xlim = c(0, 10))
```

##
```{r, echo = TRUE, eval = FALSE}
library(MASS)
model <- fitdistr(danish, 'lognormal')
```
```{r, echo = FALSE}
hist(danish, breaks = 800, probability = TRUE, 
     main = 'Danish fire losses', 
     xlab = "millions of Danish Krone",
     ylab = "relative frequency",
     xlim = c(0, 10))
library(MASS)
model <- fitdistr(danish, 'lognormal')
model_coeff <- coefficients(model)

plot_range <- seq(0, 10, 0.1)
fitted_values <- dlnorm(plot_range, 
                        meanlog = model_coeff['meanlog'], 
                        sdlog = model_coeff['sdlog'])
lines(plot_range, fitted_values, col = 'red', lwd = 2)
```


## Examples - features engieering
Data: Death numbers, ~100 features, a few K datapoints.
![Image](img//t-sne_plot_3_650.png)


## Examples - Model fit evaluation  
```{r, echo = TRUE}
lognormal_model <- fitdistr(danish, 'lognormal')
gamma_model <- fitdistr(danish, 'gamma')
print(c(lognormal_model$loglik, gamma_model$loglik))
```
Hard to understand what they actually mean!

##
```{r, echo = FALSE}
hist(danish, breaks = 800, probability = TRUE, 
     main = 'Danish fire losses', 
     xlab = "millions of Danish Krone",
     ylab = "relative frequency",
     xlim = c(0, 10))
library(MASS)
plot_range <- seq(0, 10, 0.1)
ln_model_coeff <- coefficients(lognormal_model)
lognormal_fitted_values <- dlnorm(plot_range, 
                        meanlog = ln_model_coeff['meanlog'], 
                        sdlog = ln_model_coeff['sdlog'])

ga_model_coeff <- coefficients(gamma_model)
gamma_fitted_values <- dgamma(plot_range, 
                        shape = ga_model_coeff['shape'], 
                        rate = ga_model_coeff['rate'])

lines(plot_range, lognormal_fitted_values, col = 'red', lwd = 2)
lines(plot_range, gamma_fitted_values, col = 'blue', lwd = 2)
```


## Examples - Residual analysis{.smaller}
Here is the output of a linear regression model.
```{r, echo = FALSE}
x <- seq(0, 3, 0.01)
y <- sin(x*100) / 5 + x
lm_model <- lm(y~x)
summary(lm_model)
```
##
```{r}
plot(x,y, type = 'l')
lines(x, fitted(lm_model), col = 'red', lwd = 2)
```

##
```{r}
res <- y - fitted(lm_model)
plot(x, res, type = 'l', ylim = c(-0.4, 0.4))
```
Fairly clear we have missed something.



## R commands

?COMMAND_NAME, e.g. 
```{r, echo=T}
?max
```

install.packages("PACKAGE_NAME"), e.g.
```{r, echo = T, eval = FALSE}
install.packages("d3heatmap")
```


## Influential R packages

"2013 - current - future" regime: 

- magrittr, tidyr, dplyr

$\\$

"2016 - future" regime : 

- broom, purrr


## Good data structure

"Data sets come in many formats...but R prefers just one." - Garrett Grolemund

(See other slides.) 

Reference: data wrangling with R https://www.rstudio.com/resources/webinars/data-wrangling-with-r-and-rstudio/

<!-- ## Working with good data structure -->
<!-- See R demo. -->

<!-- Reference: https://cran.r-project.org/web/packages/broom/vignettes/kmeans.html -->

#Static graphics

## Static graphcis tasks preview

- Task 1.  **What do my data look like?** The 'tabplot' package.
- Task 2. **Are my predictor variables correlated?** The 'corrplot' package.
- Task 3. **I need professional graphics for publishing purposes.** The 'ggplot2' package.


## Task 1. What do my data look like? | The 'tabplot' package.
```{r, eval = FALSE}
library(ggplot2)
data(diamonds)

library(tabplot)
tableplot(diamonds)
```
##{.smaller}
```{r, echo = FALSE}
library(ggplot2)
data(diamonds)

library(tabplot)
tableplot(diamonds)
```

Reference: http://www.jds-online.com/file_download/379/JDS-1108.pdf


## Task 2. Are my predictor variables correlated? | The 'corrplot' package.
```{r, echo = TRUE, eval = FALSE}
load('input_output//cleaned_data', verbose = T)

library(corrplot)
correlation_matrix <- cor(data1[,10:30]) 
corrplot(correlation_matrix, order = "hclust", addrect = 8)
```
##
```{r, echo = FALSE, eval = TRUE}
load('input_output//cleaned_data', verbose = T)

library(corrplot)
correlation_matrix <- cor(data1[,10:30]) 
corrplot(correlation_matrix, order = "hclust", addrect = 8)
```


## Task 3. I need professional graphics for publishing purposes. | The 'ggplot2' package. 
- Professional plots are not quick plots.
- Always have your cheatsheets right next to you.

    - https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf
    - https://flowingdata.com/2015/03/17/r-cheat-sheet-for-graphical-parameters/
- Leverage what you have
- Do not over-customise your graphics

## Professional plots - some examples
<!-- ## Professional plots - some examples -->
<!-- ![Image](img//relationship_status_before_after.jpg) -->

<!-- ## Professional plots - some examples -->
<!-- ![Image](img//london_inspired_before_after.jpg) -->

<!-- ## Professional plots - some examples -->
<!-- ![Image](img//cycle_before_after.jpg) -->
References: 

- http://theinformationcapital.com/coder-designer/
- http://spatial.ly/2014/11/r-visualisations-design/


<!-- ## Grammar of Graphics and ggplot2 -->

<!-- System to generate graphics. -->
<!-- How to express a chart -->
<!-- How to create new charts. -->


<!-- ## Layered Grammar of Graphics -->

<!-- See *The Grammar of Graphics* (Wilkinson, 2005) -->
<!-- See *ggplot2: Elegant Graphics for Data Analysis* (Wickham, 2009) -->

<!-- ## Quick plots VS Professional plots -->

<!-- ## Quick - R plot -->
<!-- ```{r, echo = TRUE, eval = FALSE} -->
<!-- my_x <- 1:10 -->
<!-- my_y <- my_x * sin(my_x) -->
<!-- my_y2 <- my_y + rnorm(10, mean = 0, sd = 5) -->

<!-- plot(x = my_x, y = my_y)     #plot(my_x, my_y) also works -->
<!-- lines(my_x, my_y2) -->
<!-- ``` -->
<!-- ## -->
<!-- ```{r, echo = FALSE, eval = TRUE} -->
<!-- my_x <- 1:10 -->
<!-- my_y <- my_x * sin(my_x) -->
<!-- my_y2 <- my_y + rnorm(10, mean = 0, sd = 5) -->

<!-- plot(x = my_x, y = my_y)     #plot(my_x, my_y) also works -->
<!-- lines(my_x, my_y2) -->
<!-- ``` -->


<!-- ## Quick plots - qplot -->
<!-- ```{r, echo = TRUE, eval = FALSE} -->
<!-- plot(x = my_x, y = my_y)     #plot(my_x, my_y) also works -->
<!-- lines(my_x, my_y2) -->

<!-- library(ggplot2) -->
<!-- qplot(x = my_x, y = my_y) + -->
<!--   geom_line(aes(my_x, my_y2)) -->
<!-- ``` -->
<!-- ## -->
<!-- ```{r, echo = FALSE, eval = TRUE} -->
<!-- qplot(x = my_x, y = my_y) + geom_line(aes(my_x, my_y2)) -->
<!-- ``` -->

<!-- ## Quick plots - ggplot -->
<!-- ```{r} -->
<!-- library(ggplot2) -->
<!-- my_data <- data.frame(my_x, my_y) -->
<!-- ggplot(my_data, aes(x = my_x, y = my_y)) + geom_line() -->
<!-- ``` -->


## ggplot2 - Graphics in 'The Economist'
We are going to create a plot similar to this: 
![Image](img//economist_samples//20110917_WOC618.gif)


<!-- ## Some ggplot features that you can't miss -->

<!-- ## ggplot facet -->

<!-- ## ggplot theme -->


#Interactive graphics

## Do we really need interactive graphics?
```{r, echo = F, message = F, warning=FALSE}
# system("mkdir ~/.fonts")
# system("cp xkcd.ttf  ~/.fonts")
# font_import(".")
# loadfonts()
library(ggplot2)
library(ggthemes)
library(extrafont)
library(xkcd)
loadfonts()
x <- 0:12
y <- c(10*c(0:2), 10*2 + 1.1*c(3:9 - 2), 28.4 + 8*(10:12 - 9))
myData <- data.frame(x = x, y = y)
ggplot(myData, aes(x = x, y = y)) + geom_line(lwd = 2, aes(x = x, y = jitter(y, factor = 7))) +
  labs(title = "Productivity gain vs Number of features",
       x = "Amount of features", y = "Productivity Gain") +
  scale_x_continuous(breaks=c(0, 3, 7, 10.5),
                     labels = c("None", "A few", "Some", "Many")) +
  scale_y_continuous(breaks=c(0, 25, 50),
                     labels = c("None", "Some", "A lot")) +
   theme_xkcd()
```




## R packages

Specialized packages: 

- **d3heatmaps, leaflet (for maps), DT (for tables)**
- They do what they say they do. **Nothing more**, nothing less.

General packages: 

- **plotly**, ggvis, rCharts, googleVis
- See review @ http://www.r-bloggers.com/interactive-visualizations-with-r-a-minireview/

## Interactive graphics tasks preview
- Task 1. **Where is this datapoint?** The 'leaflet' package.
- Task 2. **Show me my data without overcrowding the screen.** The 'DT' package.
- Task 3. **I'd like to visualise this matrix.** The 'd3heatmap' package.
- Task 4. **I need interactivity for everything!** The 'plotly' package.


## Task 1. Where is this datapoint? | The 'leaflet' package.
Two things you need to construct a basic map:

- Geographical coordinates (and potentially the corresponding data)
- Map style

##
```{r}
load('input_output//leaflet_data')
head(map_data, 5)
```

## Leaflet - Minimal example
```{r, eval = FALSE}
library(magrittr)  #for the %>% pipeline operator
library(leaflet)
leaflet(data = map_data) %>% addTiles() %>%
  addMarkers(~longitude, ~latitude, popup = ~as.character(station_name))
```
----
```{r, echo = FALSE}
library(magrittr)   #for the %>% pipeline operator
filepath <- 'data//leaflet_sample.csv'
map_data <- read.csv(filepath, header = T) %>% dplyr::filter(pressure == 2000)
map_data$trend_coeff %<>% round(3)

library(leaflet)
leaflet(data = map_data) %>% addTiles() %>%
  addMarkers(~longitude, ~latitude, popup = ~as.character(station_name))
```


## Leaflet - Other easy options

- Can use *addProviderTiles(XXX)* for other styles of map
- Some options for *XXX* are "Stamen.Toner", "Acetate.terrain", "CartoDB.Positron"
- Reference: https://rstudio.github.io/leaflet/

##
```{r, eval = FALSE}
leaflet(data = map_data) %>% addProviderTiles("Stamen.Toner") %>%
  addMarkers(~longitude, ~latitude, popup = ~as.character(station_name))
```
```{r, echo = FALSE}
leaflet(data = map_data) %>% addProviderTiles("Stamen.Toner") %>%
  addMarkers(~longitude, ~latitude, popup = ~as.character(station_name))
```


## Task 2. Show me my data without overcrowding the screen | The 'DT' package. 
```{r, eval = FALSE}
data(iris)
DT::datatable(iris)
```

##
```{r, echo = FALSE}
data(iris)
DT::datatable(iris)
```


## DT - Other easy options
```{r, eval = FALSE}
library(DT)
datatable(iris, options = list(pageLength = 6)) %>%
   formatStyle('Sepal.Width',
               backgroundColor = styleInterval(3, c('orange', 'white')))
```
##
```{r, echo = FALSE}
library(DT)
datatable(iris, options = list(pageLength = 6)) %>%
   formatStyle('Sepal.Width',
               backgroundColor = styleInterval(3, c('orange', 'white')))
```
Reference: https://rstudio.github.io/DT/


## Task 3. I'd like to visualise this matrix. | The 'd3heatmap' package.
Usage: explore data
```{r, eval = FALSE}
data(mtcars)  #built-in dataset in R
library(d3heatmap)
d3heatmap(mtcars, scale = "column", colors = "Spectral")
```
##
```{r, echo = FALSE}
data(mtcars)  #built-in dataset in R
library(d3heatmap)
d3heatmap(mtcars, scale = "column", colors = "Spectral")
```

<!-- ## -->
<!-- Usage: examine correlated predictors -->
<!-- ```{r, eval = FALSE} -->
<!-- load('input_output//cleaned_data', verbose = T) -->
<!-- library(d3heatmap) -->
<!-- d3heatmap(data1[,30:50]) -->
<!-- ``` -->
<!-- ## -->
<!-- ```{r, echo = FALSE} -->
<!-- load('input_output//cleaned_data', verbose = T) -->
<!-- library(d3heatmap) -->
<!-- d3heatmap(data1[,30:50]) -->
<!-- ``` -->


##
Usage: explore correlation between predictors
```{r, eval = FALSE}
load('input_output//cleaned_data', verbose = T)
library(d3heatmap)
correlation_matrix <- cor(data1[,2:50])
d3heatmap(correlation_matrix, dendrogram = 'none')
```
##
```{r, echo = FALSE}
load('input_output//cleaned_data', verbose = T)
library(d3heatmap)
correlation_matrix <- cor(data1[,2:50])
d3heatmap(correlation_matrix, dendrogram = 'none')
```


## Task 4. I need interactivity for everything! | The 'plotly' package. 

Supports: Matlab, Python, R, Javascript, Excel and Others.

Reference:

1. Documentation @ https://plot.ly/r/reference/
2. Gallery with source codes @ https://plot.ly/feed/


## Plotly basics
Five components:

1. plot_ly
2. add_trace
3. layout
4. annotation_text
5. other options: how to read the documentation






## The End
Next week: ShinyR and Tableau



<!-- #Bottom line: GUI interface -->
<!-- RcmdrPlugin.KMggplot2 -->
